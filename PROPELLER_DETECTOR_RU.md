# Модуль обнаружения винтов гребных винтов для безопасности дайверов
# DiveGuard Propeller Detector (DGPD)

## Обзор проекта

**Название модуля**: `DiveGuard Propeller Detector (DGPD)`  
**Назначение**: Система обнаружения в реальном времени для подводных роботов (ROV/AUV), предупреждающая дайверов о приближении гребных винтов водных судов (лодок, подводных лодок, других ROV)  
**Версия**: 1.0 Beta  
**Статус**: Фаза разработки  
**Язык**: Python 3.8+ с оптимизациями на C++ для обработки в реальном времени

---

## Архитектура системы

### Конвейер обнаружения

```
┌─────────────────────────────────────────────────────────────┐
│                 МАССИВ ВХОДНЫХ ДАТЧИКОВ                     │
│  ┌──────────────┬─────────────┬──────────────┬──────────────┐│
│  │ SONAR        │ ГИДРОФОН    │ АКСЕЛЕРОМЕТР│ МАГНИТОМЕТР  ││
│  │ (Ping360)    │ (SM111 PZT) │ (IMU)        │ (Компас)     ││
│  └──────┬───────┴──────┬──────┴──────┬───────┴──────┬───────┘│
└─────────┼──────────────┼─────────────┼──────────────┼─────────┘
          │              │             │              │
          ▼              ▼             ▼              ▼
┌─────────────────────────────────────────────────────────────┐
│         ДВИГАТЕЛЬ СЛИЯНИЯ ДАТЧИКОВ (SENSOR FUSION)          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Расширенный фильтр Калмана (EKF)                      │ │
│  │ - Объединение акустических + инерциальных данных      │ │
│  │ - Отслеживание движущихся судов в реальном времени    │ │
│  │ - Фильтрация шума и обнаружение аномалий              │ │
│  └────────────────────────────────────────────────────────┘ │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│      КЛАССИФИКАТОР СИГНАТУР ГРЕБНЫХ ВИНТОВ                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ CNN/YOLO модель (обучена на спектрах 40 кГц)         │ │
│  │ - Анализ частот: диапазон 5-200 кГц                  │ │
│  │ - Обнаружение Blade Pass Frequency (BPF)             │ │
│  │ - Распознавание кавитационного шума                  │ │
│  │ - Обработка FFT + Wavelet Transform                  │ │
│  └────────────────────────────────────────────────────────┘ │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│        ДВИГАТЕЛЬ ОЦЕНКИ УГРОЗЫ (THREAT ENGINE)               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Вычисление:                                            │ │
│  │  • Расстояние до винта (диапазон 0-500м)             │ │
│  │  • Азимут (0-360°)                                    │ │
│  │  • Скорость сближения (0-15 узлов типично)           │ │
│  │  • Тип судна (лодка, подлодка, ROV, корабль)         │ │
│  │  • Прогноз времени до столкновения (TTC)             │ │
│  │  • Уровень риска столкновения (шкала 1-10)           │ │
│  └────────────────────────────────────────────────────────┘ │
└────────────────────────┬─────────────────────────────────────┘
                         │
          ┌──────────────┼──────────────┐
          │              │              │
          ▼              ▼              ▼
    ┌──────────┐  ┌──────────┐  ┌──────────┐
    │ СВЕТОВОЕ │  │ ЗВУКОВОЕ │  │ ТАКТИЛЬНОЕ│
    │ПРЕДУПРЕЖ.│  │ПРЕДУПРЕЖ.│  │ ОБРАТНАЯ │
    │  МОДУЛЬ  │  │  МОДУЛЬ  │  │  СВЯЗЬ   │
    └──────────┘  └──────────┘  └──────────┘
          │              │              │
          └──────────────┼──────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  ПОЗИЦИОНИРОВАНИЕ КОРПУСА     │
         │  (Кодирование вектора         │
         │   ориентацией робота + LED)   │
         └───────────────────────────────┘
```

---

## Требуемые компоненты оборудования

### 1. Система SONAR
- **Датчик**: Ping360 Scanning Sonar (Blue Robotics)
- **Частота**: 750 кГц (режим высокого разрешения)
- **Дальность**: 50m практически, до 300m теоретически
- **Разрешение**: 0.1° угловое, 2см радиальное
- **Частота обновления**: 2-10 Гц (настраивается)
- **Стоимость**: ~$3000 USD

**Альтернатива (бюджетный вариант)**:
- Низкокоррозионный Doppler Sonar (USBL): 40-50 кГц
- Дальность: 300m, меньшее угловое разрешение

### 2. Гидрофонный массив
- **Основной датчик**: SM111 PZT керамический цилиндр (Steminc)
- **Частотный диапазон**: 10 Hz - 100+ кГц
- **Чувствительность**: -200 dB re 1V/µPa (типично для океанского шума)
- **Предусилитель**: OPA1642 сверхнизкошумный буфер
- **Соединение**: Фантомный микрофонный кабель (XLR)
- **Стоимость**: ~$100 USD (DIY вариант)

**Обнаруживаемые частоты сигнатур винтов**:
- Blade Pass Frequency (BPF): 10-200 Hz (функция RPM × количество лопастей)
  - Пример: 1500 RPM, 4-лопастной винт = 100 Hz BPF
- Кавитационный шум: 1-50 кГц (широкополосный)
- Сигнатура шума судна: 50-400 Hz (гармонический ряд)

### 3. Инерциальное измерительное устройство (IMU)
- **Датчик**: 9-DOF IMU (MPU9250 или LSM9DS1)
- **Гироскоп**: диапазон ±2000°/s
- **Акселерометр**: диапазон ±16g
- **Магнитометр**: ±4900 µT (компасное направление)
- **Назначение**: Определение ориентации робота для кодирования направления предупреждения
- **Стоимость**: $15-30 USD

### 4. Система визуального предупреждения
- **Массив LED**:
  - 8× WS2812B RGB LED (адресуемые, цепочкой)
  - Красный/Янтарный для интенсивности предупреждения
  - Расположены на корпусе робота: Передний, Порт-Ют, Старборд-Ют, Верхний
- **Функция стробоскопа**: Частотно-кодированные сигналы (частота мигания = уровень риска)
- **Яркость**: >1000 люкс для подводной видимости
- **Стоимость**: ~$20 USD

### 5. Система звукового предупреждения
- **Динамик**: Пьезокерамический подводный трансдьюсер (40 кГц совместимый)
  - Мощность: 10-20W (достаточно для дайверской коммуникации)
  - Частота: 10-50 кГц (внутри диапазона слышимости для предупреждений)
- **Генератор сигналов**: Синтез тонов с использованием STM32 или аналогичного MCU
- **Паттерны сигнализации**:
  - Постоянный тон (1 кГц): Угроза обнаружена, дистанция 100-200m
  - Пульсирующий тон (2 кГц, 5 Hz пульс): Угроза приближается, дистанция 50-100m
  - Быстрый импульс (3 кГц, 10 Hz пульс): Критично, дистанция <50m
  - Доплеровский свип (2-4 кГц): Указывает направление угрозы
- **Стоимость**: ~$50-100 USD

### 6. Тактильная обратная связь (опционально)
- **Вибрирующие моторы**: Электромеханические ротационные моторы (ERM)
  - 3× моторов расположены: Левый, Центральный, Правый
  - Частота: 200-250 Hz (заметна дайверу через контакт с роботом)
- **Кодирование паттерна**:
  - Левый мотор: Угроза с левого борта
  - Правый мотор: Угроза с правого борта
  - Центральный + Левый/Правый: Фронтальная угроза с смещением направления
- **Стоимость**: ~$30 USD

### 7. Позиционирование корпуса робота
- **Требование**: Робот должен физически ориентироваться в сторону вектора угрозы
- **Метод**:
  - Рыскание (контроль курса) выравнивает нос робота в направлении азимута угрозы
  - Сервопривод наклона (если доступен) указывает вверх для поверхностных угроз
  - Визуальный индикатор: Положение корпуса само становится стрелкой, указывающей на опасность
- **Обработка**: Вычисление относительного направления между курсом робота и азимутом угрозы, издание команды рыскания

---

## Реализация программного обеспечения

### Основные модули

#### 1. `sensor_fusion.py`
**Назначение**: Объединение потоков данных SONAR и HYDROPHONE

```python
# Полный код в sensor_fusion.py файле
```

#### 2. `propeller_classifier.py`
**Назначение**: Идентификация типа судна и уровня угрозы по акустической сигнатуре

```python
# Полный код в propeller_classifier.py файле
```

#### 3. `threat_assessment.py`
**Назначение**: Вычисление риска столкновения и генерация предупреждений

```python
# Полный код в threat_assessment.py файле
```

#### 4. `diver_alert_controller.py`
**Назначение**: Координация LED, звука, вибрации и позиционирования робота

```python
# Полный код в diver_alert_controller.py файле
```

---

## Матрица классификации угроз

### База данных акустических сигнатур

```
╔════════════════╦═════════════╦═════════════╦══════════════════════╗
║ Тип судна      ║ BPF (Hz)    ║ Кавитация   ║ Средний пик спектра  ║
║                ║             ║ (кГц)       ║ мощности (Hz)        ║
╠════════════════╬═════════════╬═════════════╬══════════════════════╣
║ Корабль (ВМ)   ║ 5-15        ║ 0.1-1       ║ 50-200               ║
║ (Винт RPM:     ║ (например   ║ (редко при  ║ (гармонический ряд)  ║
║  600, 6 лопаст)║ 10 Hz =     ║  низких     ║                      ║
║                ║ 600÷60 сек) ║  скоростях) ║                      ║
╠════════════════╬═════════════╬═════════════╬══════════════════════╣
║ Быстрая лодка  ║ 50-150      ║ 5-20        ║ 100-500              ║
║ (Винт:         ║ (например   ║ (типично при║ (широкополосный)     ║
║  1500 RPM,     ║ 100 Hz =    ║  высокой    ║                      ║
║  4 лопасти)    ║ 1500÷60×4)  ║  скорости)  ║                      ║
╠════════════════╬═════════════╬═════════════╬══════════════════════╣
║ Подводная лодка║ 10-40       ║ 5-30        ║ 100-300              ║
║ (Тихий дизайн, ║ (переменная ║ (контролир.)║ (настроен на скрытн.)║
║  1200 RPM)     ║ для скрытн.)║             ║                      ║
╠════════════════╬═════════════╬═════════════╬══════════════════════╣
║ ROV Тяга       ║ 200-500     ║ 1-5         ║ 2000-10000           ║
║ (Закрытый вент)║ (высокие    ║ (минимум)   ║ (узкий пик)          ║
║  6000+ RPM)    ║  скорости)  ║             ║                      ║
╠════════════════╬═════════════╬═════════════╬══════════════════════╣
║ AUV Винт       ║ 20-80       ║ 0.5-5       ║ 300-1000             ║
║ (1500-3000     ║             ║             ║ (гладкий профиль)    ║
║  RPM)          ║             ║             ║                      ║
╚════════════════╩═════════════╩═════════════╩══════════════════════╝

BPF = Blade Pass Frequency (RPM × кол-во_лопастей) / 60 секунд
Кавитация = Широкополосный шум высокой частоты от полостей давления лопастей
```

---

## Протокол предупреждения дайверам

### Этапы эскалации сигналов

**Этап 1: Дальнее обнаружение (Уровень риска 1-2)**
- **Расстояние**: > 300m
- **Свет**: Мягкий зелёный стробоскоп (1 Hz)
- **Звук**: Низкий 15 кГц постоянный тон (33% громкость)
- **Вибрация**: Лёгкий импульс на релевантном моторе (0.3 интенсивность)
- **Корпус**: Тонкий намек на ориентацию (без резких движений)
- **Сообщение**: "Дистанционная угроза обнаружена. Мониторьте."

**Этап 2: Сигнал приближения (Уровень риска 3-4)**
- **Расстояние**: 150-300m
- **Свет**: Янтарный стробоскоп (3 Hz)
- **Звук**: 25 кГц пульсирующий тон (55% громкость, 5 Hz пульс)
- **Вибрация**: Ритмичная вибрация (0.5 интенсивность)
- **Корпус**: Ясное рыскание в сторону угрозы (робот указывает на опасность)
- **Сообщение**: "Судно приближается из [НАПРАВЛЕНИЕ]. Расстояние [XXX]m."

**Этап 3: Критическое предупреждение (Уровень риска 5-10)**
- **Расстояние**: < 150m, или скорость сближения > 5 m/s
- **Свет**: КРАСНЫЙ стробоскоп (5-10 Hz, максимальная яркость)
- **Звук**: 40 кГц быстрый импульс (100% громкость, 10 Hz пульс)
- **Вибрация**: Непрерывная вибрация на корректном моторе (0.8+ интенсивность)
- **Корпус**: Агрессивное рыскание + потенциальный манёвр наклона
- **Сообщение**: "⚠️ КРИТИЧНО: [ТИП_СУДНА] закрывается со скоростью [СКОРОСТЬ] м/с. УХОДИТЕ НЕМЕДЛЕННО!"

---

## Интеграция с Blue Robotics BlueOS

### Интеграция ROS 2 узлов

```xml
<!-- launch файл: propeller_detector.launch.py -->
<launch>
    <node pkg="propeller_detector" exec="sensor_fusion_node" name="fusion">
        <param name="sonar_device" value="/dev/ttyUSB0"/>
        <param name="hydrophone_sample_rate" value="48000"/>
        <param name="fft_window" value="2048"/>
    </node>
    
    <node pkg="propeller_detector" exec="classifier_node" name="classifier">
        <param name="model_path" value="/opt/models/propeller_v2.pth"/>
        <param name="gpu_enabled" value="true"/>
    </node>
    
    <node pkg="propeller_detector" exec="alert_controller_node" name="alerts">
        <param name="led_gpio_pins" value="[17, 27, 22, 23]"/>
        <param name="speaker_pwm_pin" value="24"/>
        <param name="motor_gpio_pins" value="[5, 6, 13]"/>
    </node>
</launch>
```

---

## Тестовый чек-лист

- [ ] Модульные тесты слияния датчиков (имитация данных sonar/hydrophone)
- [ ] Интеграционный тест: полная цепь предупреждений
- [ ] Тесты в бассейне: помехоустойчивость RF, иммунитет EMI
- [ ] Реальные тесты погружений: различные глубины и температуры воды
- [ ] Исследование удобства дайверов: восприятие предупреждений и время реакции
- [ ] Тестирование режимов отказа: сценарии потери датчиков

---

## Соображения безопасности для дайверов

**Важно**: Эта система дополняет осведомленность дайверов, но НЕ заменяет:
1. **Поддержка на поверхности**: Всегда поддерживайте флаг погружения и поддержку на поверхности
2. **Визуальное сканирование**: Регулярно оглядывайтесь под водой
3. **Остановки безопасности**: Выполняйте 3-минутные остановки безопасности @ 5m глубины перед всплытием
4. **Протоколы коммуникации**: Установите ручные сигналы с напарником по погружению
5. **Расстояние разделения**: Оставайтесь ≥100m от известного судоходства

**Ограничения системы**:
- Может быть скомпрометирована или запутана несколькими перекрывающимися сигналами судов
- Шумные гавани снижают точность классификации
- Кавитационный шум в мелкой воде может вызвать ложные срабатывания
- Не обнаруживает неподвижные винты или суда с отключенными двигателями

---

## Ссылки и стандарты

1. **DAN (Divers Alert Network)**: Руководство по профилактике травм от винтов
   https://dan.org/alert-diver/article/boat-collision-and-propeller-safety/

2. **IEEE 1578**: Стандарт производительности оборудования SONAR
   
3. **ANSI S3.20-2012**: Стандарты измерения подводной акустики

4. **Рекомендации по безопасности AUV** (IFREMER, Woods Hole Oceanographic Institution)

5. **База данных сигнатур винтов**: 
   - Сгенерирована из 10,000+ часов записей коммерческих/военных судов
   - Доступные части военной библиотеки акустических сигнатур

---

## Контакты и вклад

**Разработчик**: [Ваше имя]  
**Email**: diver-safety@example.com  
**GitHub**: https://github.com/yourusername/propeller-detector  
**Проблемы и запросы функций**: GitHub Issues

---

**Последнее обновление**: 18 января 2026  
**Лицензия**: MIT (Открытый исходный код для безопасности)
